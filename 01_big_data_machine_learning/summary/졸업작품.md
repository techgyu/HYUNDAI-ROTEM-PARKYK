# 로컬 객체 탐지 실행/배포 가이드 (Windows)

목표: 로컬 PC에서 더블클릭만으로 카메라 연결 후 객체 탐지를 시작하는 실행 파일(EXE) 또는 바로가기(.bat)를 만든다.

## 개요
- 웹 서버/Django는 불필요(로컬 전용).
- 최소 구성: Python 스크립트 + 모델 가중치 + 실행 편의(배치파일 또는 EXE).

## 사전 준비
- Python 3.9+ (권장)
- (선택) NVIDIA GPU + 적합한 CUDA 드라이버
- 인터넷(최초 모델 다운로드 시), 이후 오프라인 사용 가능

## 1) 가상환경 생성 및 설치
```bash
py -m venv .venv
.\.venv\Scripts\activate
pip install --upgrade pip
pip install ultralytics opencv-python pyinstaller
# (GPU 사용 시) https://pytorch.org/get-started/locally/ 안내에 따라 torch(+cuda) 설치
```

## 2) 실행 스크립트 작성 (yolo_run.py)
아래 예시는 웹캠 0번 장치를 열어 실시간 탐지를 표시한다.

```python
import os, sys, cv2
from ultralytics import YOLO

def resource_path(rel_path: str) -> str:
    # PyInstaller 실행 파일에서 리소스 경로 보정
    if hasattr(sys, "_MEIPASS"):
        return os.path.join(sys._MEIPASS, rel_path)
    return os.path.join(os.path.abspath("."), rel_path)

# 가중치: assets\yolov8n.pt (가벼운 모델). 파일이 없으면 자동 다운로드 사용
weights = resource_path(os.path.join("assets", "yolov8n.pt"))
if not os.path.exists(weights):
    weights = "yolov8n.pt"  # 최초 실행 시 자동 다운로드

model = YOLO(weights)

# 0 = 기본 웹캠. 다른 카메라면 1, 2...로 변경
cap = cv2.VideoCapture(0, cv2.CAP_DSHOW)
if not cap.isOpened():
    raise RuntimeError("카메라를 열 수 없습니다.")

while True:
    ok, frame = cap.read()
    if not ok:
        break
    results = model(frame, verbose=False)
    annotated = results[0].plot()
    cv2.imshow("Object Detection - Press Q to quit", annotated)
    if cv2.waitKey(1) & 0xFF == ord("q"):
        break

cap.release()
cv2.destroyAllWindows()
```

권장: 최초 한 번 실행하여 모델이 다운로드되면, 사용자 홈 캐시(`%USERPROFILE%\.cache\ultralytics`)에서 `yolov8n.pt`를 프로젝트의 `assets\yolov8n.pt`로 복사해 오프라인 실행 가능.

## 3) 동작 테스트
```bash
.\.venv\Scripts\activate
python .\yolo_run.py
```

## 4) EXE 패키징(PyInstaller)
- 가중치를 프로젝트에 포함(예: `assets\yolov8n.pt`).

```bash
mkdir assets
# yolov8n.pt를 assets에 배치한 뒤 빌드
pyinstaller --onefile --add-data "assets\yolov8n.pt;assets" yolo_run.py
# 콘솔 창 숨기려면 옵션 추가: --noconsole
# 용량/시작속도 고려해 --onedir 대안도 있음(폴더 형태 결과물)
```

- 결과: `dist\yolo_run.exe`
- 더블클릭 시 즉시 실행. 필요 시 EXE에 대해 백신 예외 등록.

## 5) 바탕화면 바로가기 만들기
- `dist\yolo_run.exe` 우클릭 → 바로 가기 만들기 → 바탕화면 이동.
- 또는 EXE를 그대로 바탕화면에 복사(권장: 바로가기).

## 6) 배치 파일(.bat) 대안
EXE 없이도 바로가기로 실행하고 싶다면:

```bat
@echo off
setlocal
cd /d "%~dp0"
call .venv\Scripts\activate
python yolo_run.py
```

- 위 파일을 `run_yolo.bat`로 저장하고 바로가기 생성.
- 바로가기 속성에서 “실행”을 “최소화”로 설정 가능.

## 7) 자주 묻는 문제/팁
- 카메라가 열리지 않음: 장치 인덱스(0,1,2…) 변경, `cv2.CAP_DSHOW` 유지, 다른 앱이 점유 중인지 확인.
- 첫 실행이 느림: 모델 다운로드/최초 컴파일 때문. 가중치를 `assets`에 포함하면 개선.
- GPU 미사용/오류: torch와 CUDA 버전 호환 필요. 맞추기 어렵다면 CPU 사용으로도 동작.
- EXE가 크다/느리다: `--onedir` 사용, 불필요한 패키지 제거 고려.
- VCRUNTIME/런타임 누락: 최신 MSVC 재배포 패키지 설치.
- 백신 오탐: 서명 또는 예외 등록 필요할 수 있음.
- UI 필요 시: Gradio/Streamlit으로 로컬 전용 웹 UI를 몇 줄로 추가 가능.

## 8) 권장 폴더 구조 예시
```
프로젝트/
 ├─ yolo_run.py
 ├─ assets/
 │   └─ yolov8n.pt
 ├─ .venv/
 └─ dist/            # 빌드 후 생성
     └─ yolo_run.exe
```

이 문서대로 진행하면 더블클릭 실행형 로컬 객체 탐지 프로그램을 만들 수 있다.